# vorder-eb

**vorder-eb** is the Node.js back-end for Vorder, a Crypto trading voice assistant. 

This project is made to be hosted on AWS Elastic Beanstalk.

In the **master** branch you'll find the latest iteration, which is this back-end solely being dedicated to handle the WebSocket routes for order input/output, and an HTTP API endpoint in /options which handles the getting and setting of the users' Binance API keys. In this iteration, the back-end is accessed through a Next.js front-end hosted on Amplify that also includes a one-page app with the presentation website, for which the source code is in **vorder-io**.

In the **fully-elastic-beanstalk** branch you'll find the first iteration of this project, where everything is served by the Node-js back-end. Server-side rendering is done via EJS views. It's much more rudimentary and doesn't use JWT's for authentication, but cookies and sessions. Note that if you want to use that version you'll need to create tables Vorder-Sessions and Vorder-Sessions-dev on DynamoDB. I deleted them from there because they're not used anymore. In the latest iteration (**master** branch) verification is done using only JWT's and so I don't need to store sessions anymore)

- Relevant Version Information for Elastic Beanstalk:

*Node.js 12 running on 64bit Amazon Linux 2/5.4.0*

- Notes:

1. The folders .ebextensions, .ebelasticbeanstalk, and .platform, contain stuff to build the environment. Those things took a lot of time to figure out how to set correctly.
1. The file config/config.js contains all the application configurations

## Installation

1. Create Elastic Beanstalk environment (called "vorder-env" for example)
1. By default, the endpoint to access this instance will be something like "Vorder-env.eba-fzgnpq3d.us-east-2.elasticbeanstalk.com". To use a custom domain, you only need to add an ALIAS record on Route 53 to point to that endpoint.
1. In the same region that the EB instances are running, create dynamoDB tables: *Vorder-Creds*, *Vorder-Creds-dev*, *Vorder-Events*, *Vorder-Events-dev*.
1. Create S3 bucket called *vorder-user-recordings*. All the audio files from the users will be stored there.
1. In the Credentials table you'll need the following objects. **Note 1**: I copied the JSON content from the dynamoDB tables. The first line corresponds to the field names, the rest is the object content, e.g. for the first one, the partition field has value "server"). Note 2: the Cognito ID's below are all generated by Amplify (auth handling is done through the Amplify CLI). When I mention *aws-exports.js* file, that's the file generated by Amplify in the project **vorder-io**.

   1. "partition (S)","id (S)","json (M)"

      "server", "cognito-user-pool", "{""client_id"" : { ""S"" : ""<**Client ID from the APP in the Cognito User Pool ("aws_user_pools_web_client_id" field in aws-exports.js file)**>"" }, ""region"" : { ""S"" : ""**<Region for Cognito User Pool>**"" }, ""user_pool_id"" : {""S"" : ""**<ID for Cognito User Pool ("aws_user_pools_id" field in aws-exports.js file)>**"" }  }"

   1. Two objects with Google Service Account JSON Keys with access to the Speech-To-Text and Text-to-Speech services. The object id's are, respectively, *google-service-account-key-1* and *google-service-account-key-2*. At the moment, I'm actually only using *google-service-account-key-2* (the other one is not needed) - see explanation on services/speech.js to understand why I even used two of them at one point.

1. Attach policy containing *iam_policy.json* to the EC2 role used by Elastic Beanstalk to allow it so access the different resources (DynamoDB, S3, etc)
1. Connect CodeCommit to the EB environment so that, at every commit, the environment will be re-deployed using the new source bundle.
1. Also clone that EB environment to create an environment for development (called "vorder-env-dev" for example). Then, connect the Codecommit dev branch to the EB dev environment.
1. The user management (registration, login, logout, etc) is done through the Next.js backend using the Amplify SDK. So for more details on that check the README in project vorder-io.

## To improve
1. This back-end could probably be done using Lambda API's in Amplify, which would remove the dependency for Elastic Beanstalk
1. I'm currently passing the JWT in the websocket handshake. That's probably not very safe as it's vulnerable to MITM attacks (although I didn't look much into whether it's really passed in plain-text. But to be safe, next time do something like this https://github.com/auth0-community/auth0-socketio-jwt)